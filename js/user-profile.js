let testUserProfileObj = {
    "userId": "dse4lme2kzttx3zgkczi08crr",
    "displayName": "Justin",
    "images": [],
    "songPopularity": {
        "0": 0,
        "1": 0,
        "2": 0,
        "3": 0,
        "4": 0,
        "5": 0,
        "6": 0,
        "7": 2,
        "8": 0,
        "9": 2,
        "10": 0,
        "11": 0,
        "12": 2,
        "13": 1,
        "14": 1,
        "15": 1,
        "16": 0,
        "17": 0,
        "18": 0,
        "19": 2,
        "20": 0,
        "21": 0,
        "22": 3,
        "23": 1,
        "24": 5,
        "25": 3,
        "26": 1,
        "27": 0,
        "28": 4,
        "29": 9,
        "30": 12,
        "31": 9,
        "32": 20,
        "33": 5,
        "34": 7,
        "35": 17,
        "36": 19,
        "37": 13,
        "38": 14,
        "39": 15,
        "40": 16,
        "41": 21,
        "42": 16,
        "43": 12,
        "44": 9,
        "45": 4,
        "46": 10,
        "47": 10,
        "48": 15,
        "49": 13,
        "50": 30,
        "51": 8,
        "52": 19,
        "53": 12,
        "54": 9,
        "55": 12,
        "56": 13,
        "57": 17,
        "58": 4,
        "59": 9,
        "60": 13,
        "61": 4,
        "62": 13,
        "63": 1,
        "64": 2,
        "65": 2,
        "66": 4,
        "67": 5,
        "68": 2,
        "69": 1,
        "70": 5,
        "71": 2,
        "72": 3,
        "73": 9,
        "74": 3,
        "75": 6,
        "76": 0,
        "77": 4,
        "78": 0,
        "79": 1,
        "80": 1,
        "81": 3,
        "82": 1,
        "83": 2,
        "84": 3,
        "85": 1,
        "86": 0,
        "87": 0,
        "88": 0,
        "89": 0,
        "90": 0,
        "91": 2,
        "92": 1,
        "93": 0,
        "94": 0,
        "95": 0,
        "96": 0,
        "97": 4,
        "98": 0,
        "99": 0,
        "100": 0
    },
    "songTimeRange": [
        {
            "year": 2012,
            "value": 16
        },
        {
            "year": 2011,
            "value": 12
        },
        {
            "year": 2010,
            "value": 4
        },
        {
            "year": 2009,
            "value": 13
        },
        {
            "year": 1987,
            "value": 25
        },
        {
            "year": 2019,
            "value": 250
        },
        {
            "year": 2018,
            "value": 48
        },
        {
            "year": 2017,
            "value": 23
        },
        {
            "year": 2006,
            "value": 1
        },
        {
            "year": 2016,
            "value": 13
        },
        {
            "year": 2015,
            "value": 32
        },
        {
            "year": 2014,
            "value": 50
        },
        {
            "year": 2003,
            "value": 12
        },
        {
            "year": 2013,
            "value": 11
        },
        {
            "year": 2002,
            "value": 15
        }
    ],
    "topGenres": [
        {
            "weight": 244,
            "name": "art pop"
        },
        {
            "weight": 231,
            "name": "escape room"
        },
        {
            "weight": 185,
            "name": "electropop"
        },
        {
            "weight": 154,
            "name": "indietronica"
        },
        {
            "weight": 148,
            "name": "dance pop"
        },
        {
            "weight": 134,
            "name": "indie pop"
        },
        {
            "weight": 131,
            "name": "dream pop"
        },
        {
            "weight": 125,
            "name": "new rave"
        },
        {
            "weight": 125,
            "name": "hyperpop"
        },
        {
            "weight": 113,
            "name": "indie rock"
        },
        {
            "weight": 112,
            "name": "chillwave"
        },
        {
            "weight": 105,
            "name": "alternative rock"
        },
        {
            "weight": 104,
            "name": "chamber pop"
        },
        {
            "weight": 97,
            "name": "alternative dance"
        },
        {
            "weight": 95,
            "name": "freak folk"
        },
        {
            "weight": 94,
            "name": "noise pop"
        },
        {
            "weight": 87,
            "name": "lo-fi"
        },
        {
            "weight": 81,
            "name": "pop"
        },
        {
            "weight": 78,
            "name": "rock"
        },
        {
            "weight": 78,
            "name": "pop rap"
        }
    ],
    "topArtists": null,
    "topAlbums": [
        {
            "albumId": "7qBdr5VAmWMSJ7dij0mV3f",
            "weight": 4.0,
            "name": "Pyroclasts",
            "artist": "Sunn 0)))",
            "albumCoverImgURL": "https://i.scdn.co/image/07a1a6efe8ad006abfac61572f959a7bf0d81369"
        },
        {
            "albumId": "4ClyeVlAKJJViIyfVW0yQD",
            "weight": 3.857142857142857,
            "name": "Pang",
            "artist": "Caroline Polachek",
            "albumCoverImgURL": "https://i.scdn.co/image/889d8573e039c3f3e3cdbef79b0f44cc30d44bd1"
        },
        {
            "albumId": "4UhaqAS8V23KozB3dzLMax",
            "weight": 3.176470588235294,
            "name": "pom pom",
            "artist": "Ariel Pink",
            "albumCoverImgURL": "https://i.scdn.co/image/ab67616d00001e023ec144b51b97424b0f0decb5"
        },
        {
            "albumId": "0hn6oMN4fgYbFpCVHBkzSI",
            "weight": 2.5,
            "name": "Crash Pad/King for a Day",
            "artist": "George Clanton",
            "albumCoverImgURL": "https://i.scdn.co/image/bf15c1bdc960afeaa166f6358dacf0beb958c60a"
        },
        {
            "albumId": "6G8IwjN1Kdp0MncExVx6cF",
            "weight": 2.5,
            "name": "Violence",
            "artist": "Grimes",
            "albumCoverImgURL": "https://i.scdn.co/image/fa16237ad368be7bbc4d45b5b436299ce8a18077"
        },
        {
            "albumId": "0CKiI5WdJ5rzUIK8hyD3SY",
            "weight": 2.4444444444444446,
            "name": "OIL OF EVERY PEARL'S UN-INSIDES",
            "artist": "SOPHIE",
            "albumCoverImgURL": "https://i.scdn.co/image/ab67616d00001e0290efbb6f4bd415bf5f22c136"
        },
        {
            "albumId": "4BlLJn9RjIJ9WufqeufTCU",
            "weight": 2.333333333333333,
            "name": "HANADRIEL",
            "artist": "HANA",
            "albumCoverImgURL": "https://i.scdn.co/image/a4115a07d79ae3b2cba74ed740fe2a7c03e9a12c"
        },
        {
            "albumId": "4o51Lr7wqWzIsR7wbgjN6U",
            "weight": 2.166666666666667,
            "name": "Peanuts Greatest Hits (Music From The TV Specials)",
            "artist": "Vince Guaraldi Trio",
            "albumCoverImgURL": "https://i.scdn.co/image/4648449a9d6500f89bb2a2a23f63efeea2a643ea"
        },
        {
            "albumId": "6vuykQgDLUCiZ7YggIpLM9",
            "weight": 2.090909090909091,
            "name": "A Moon Shaped Pool",
            "artist": "Radiohead",
            "albumCoverImgURL": "https://i.scdn.co/image/ab67616d00001e020365011d800890bd210dd043"
        },
        {
            "albumId": "5DLhV9yOvZ7IxVmljMXtNm",
            "weight": 2.090909090909091,
            "name": "El Camino",
            "artist": "The Black Keys",
            "albumCoverImgURL": "https://i.scdn.co/image/ab67616d00001e026a21b97de47168df4f0c1993"
        },
        {
            "albumId": "386IqvSuljaZsMjwDGGdLj",
            "weight": 2.0666666666666664,
            "name": "Charli",
            "artist": "Charli XCX",
            "albumCoverImgURL": "https://i.scdn.co/image/ab67616d00001e02cee4acc7bfe23bc75461a66c"
        },
        {
            "albumId": "45StnugV9WQMQwk4rRoTy8",
            "weight": 2.041666666666667,
            "name": "Louder Than Bombs",
            "artist": "The Smiths",
            "albumCoverImgURL": "https://i.scdn.co/image/ab67616d00001e02ed3953f8af1f764a146b7583"
        },
        {
            "albumId": "5hB4jVN4ZHpubyiMmW81K1",
            "weight": 2.0,
            "name": "Art Angels",
            "artist": "Grimes",
            "albumCoverImgURL": "https://i.scdn.co/image/000ffb25a44dd4aea66d7d03098a81b667685d4d"
        },
        {
            "albumId": "5butUAMQEYVZAeQEFuhG3J",
            "weight": 2.0,
            "name": "Choke",
            "artist": "Poppy",
            "albumCoverImgURL": "https://i.scdn.co/image/ab67616d00001e02d9bed8db401839868909f77d"
        },
        {
            "albumId": "2GBJg7nTQs3go1w24ECKvy",
            "weight": 2.0,
            "name": "CALIGULA",
            "artist": "Lingua Ignota",
            "albumCoverImgURL": "https://i.scdn.co/image/ab67616d00001e02b4bcefe6e54045d9fad31c6c"
        },
        {
            "albumId": "12Biup1Sq5hpHsX85gJPb2",
            "weight": 2.0,
            "name": "Slide",
            "artist": "George Clanton",
            "albumCoverImgURL": "https://i.scdn.co/image/ab67616d00001e0254823b660c0985479ea17f08"
        },
        {
            "albumId": "2Ek1q2haOnxVqhvVKqMvJe",
            "weight": 2.0,
            "name": "ye",
            "artist": "Kanye West",
            "albumCoverImgURL": "https://i.scdn.co/image/cefa3771cde228b60c6dd48945b69d37ab71a847"
        },
        {
            "albumId": "74r6JJ97ipO0CREXP9PMqZ",
            "weight": 2.0,
            "name": "New Energy",
            "artist": "Four Tet",
            "albumCoverImgURL": "https://i.scdn.co/image/ab67616d00001e023f31769b727102837cb32a63"
        },
        {
            "albumId": "33u2PRETjYklC6UqxJBGW2",
            "weight": 2.0,
            "name": "Miami Memory",
            "artist": "Alex Cameron",
            "albumCoverImgURL": "https://i.scdn.co/image/ab67616d00001e02bf96842d5f15a8a49d12ab67"
        },
        {
            "albumId": "48a7rOjTzpD1zzJAteeveE",
            "weight": 2.0,
            "name": "Visions",
            "artist": "Grimes",
            "albumCoverImgURL": "https://i.scdn.co/image/ab67616d00001e02cdd80f8264878306d278cd2a"
        }
    ],
    "recentlyPlayedPlaylistURI": null
}

function renderUserProfile(userProfileObj) {
    if (!userProfileObj) {
        userProfileObj = testUserProfileObj;
    }
    // Render user image
    const userImageRow = document.createElement('div');
    userImageRow.className = "row";
    const userImageCol = document.createElement('div');
    userImageCol.className = "col-lg";
    userImageCol.align = "center";
    const userImage = document.createElement('img');
    if (userProfileObj.images[0])
        userImage.src = userProfileObj.images[0]['url'];
    else
        userImage.src = 'https://statici.behindthevoiceactors.com/behindthevoiceactors/_img/chars/linus-van-pelt-charlie-browns-all-stars-46.9.jpg'
    userImage.className = "rounded-circle mt-4";
    userImage.style = "width:12em;height:12em";
    userImageCol.appendChild(userImage);
    userImageRow.appendChild(userImageCol);
    document.getElementById('user-info-container').appendChild(userImageRow);
    // Render user display name
    const userDisplayNameRow = document.createElement('div');
    userDisplayNameRow.className = "row";
    const userDisplayNameCol = document.createElement('div');
    userDisplayNameCol.className = "col-lg";
    userDisplayNameCol.align = "center";
    const userDisplayNameHeader = document.createElement('h2');
    userDisplayNameHeader.className = "text-white";
    userDisplayNameHeader.style = "padding-top:0.5em;"
    userDisplayNameHeader.innerHTML = 'Welcome, ' + userProfileObj.displayName + '!';

    userDisplayNameCol.appendChild(userDisplayNameHeader);

    userDisplayNameRow.appendChild(userDisplayNameCol);
    document.getElementById('user-info-container').appendChild(userDisplayNameRow);
}

function renderFavoriteGenres(userProfileObj) {
    if (!userProfileObj) {
        userProfileObj = testUserProfileObj;
    }
    const genreObj = { 'children': userProfileObj['topGenres'] };
    const diameter = 800;
    const color = d3.scaleOrdinal(d3.schemeCategory20);
    const bubble = d3.pack(genreObj)
        .size([diameter, diameter])
        .padding(1.5);
    const svg = d3.select("#genre-chart-column")
        .append("svg")
        .attr("width", diameter)
        .attr("height", diameter)
        .attr("class", "bubble");
    const nodes = d3.hierarchy(genreObj)
        .sum(function(d) { return d.weight; });
    const node = svg.selectAll(".node")
        .data(bubble(nodes).descendants())
        .enter()
        .filter(function(d) {
            return !d.children
        })
        .append("g")
        .attr("class", "node")
        .attr("transform", function(d) {
            return "translate(" + d.x + "," + d.y + ")";
        });
    node.append("title")
        .text(function(d) {
            return d.name + ": " + d.weight;
        });
    node.append("circle")
        .attr("r", function(d) {
            return d.r;
        })
        .style("fill", function(d, i) {
            return color(i);
        });
    node.append("text")
        .attr("dy", ".2em")
        .style("text-anchor", "middle")
        .text(function(d) {
            return d.data.name;
        })
        .attr("font-family", "sans-serif")
        .attr("font-size", function(d) {
            return d.r / 5;
        })
        .attr("fill", "white");

    d3.select(self.frameElement)
        .style("height", diameter + "em");
}

function renderFavoriteAlbums(userProfileObj) {
    if (!userProfileObj) {
        userProfileObj = testUserProfileObj;
    }
    const albumObj = userProfileObj['topAlbums']
    // Compute number of rows needed
    const rowLength = Math.floor(albumObj.length / 5);
    if (albumObj.length % 5 > 0) rowLength++;
    // Number of albums we've filled into a column. Used to make sure we don't check an index out of bounds in the album array.
    let albumCount = 0;
    // Create rowLength number of rows with 4 columns each
    for (i = 0; i < rowLength; i++) {
        // Create a row div
        const rowDiv = document.createElement('div');
        rowDiv.className = 'row no-gutters';
        // Append 4 column divs into the row div.
        for (j = 0; j < 4; j++) {
            // If albumCount has exceeded album array length, then leave empty. Otherwise fill with album info.
            const colDiv = document.createElement('div');
            colDiv.className = 'col-sm';
            if (albumCount < albumObj.length) {
                // Create viewOverlayDiv for hover effect capability
                const viewOverlayDiv = document.createElement('div');
                viewOverlayDiv.className = 'view overlay mx-2';
                // Append the album img to viewOverlayDiv
                const albumArtImg = document.createElement('img');
                albumArtImg.className = 'img-fluid';
                albumArtImg.src = albumObj[albumCount].albumCoverImgURL;
                viewOverlayDiv.appendChild(albumArtImg);
                // Append maskDiv to viewOverlayDiv which enables the hover effect
                const maskDiv = document.createElement('div');
                maskDiv.className = 'mask flex-center rgba-white-strong';
                // Append text to maskDiv to show up when hovering
                const albumTitleP = document.createElement('p');
                albumTitleP.className = 'text-break black-text text-center font-weight-bold';
                albumTitleP.innerHTML = albumObj[albumCount].name; //+ "<br>" + albumObj.albums[albumCount].artist;
                maskDiv.appendChild(albumTitleP);
                viewOverlayDiv.appendChild(maskDiv);
                colDiv.appendChild(viewOverlayDiv);
                albumCount++;
            }
            rowDiv.appendChild(colDiv);
        }
        // Append the row div onto collageContainer div
        document.getElementById('collage-container').appendChild(rowDiv);
    }
}

const refresh_token = localStorage.getItem('refreshToken');
const userProfileUrl = 'https://my-tunes-be.herokuapp.com/userProfileModel?refreshToken=' + refresh_token;

const subContainer = document.getElementById('sub-container');
subContainer.style.display = 'none';

fetch(userProfileUrl)
    .then(res => res.json())
    .then(jsondata => {
        console.log(jsondata);
        subContainer.style.display = 'block';
        document.getElementById('loader').style.display = 'none';

        renderUserProfile(jsondata);
        renderFavoriteAlbums(jsondata);
        renderFavoriteGenres(jsondata);
    });