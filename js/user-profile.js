// For testing purposes
/*
testUserProfileObj = {
    "userId": "dvu408",
    "displayName": "dvu408",
    "images": [{
        "height": null,
        "url": "https://profile-images.scdn.co/images/userprofile/default/a9634eb7d62f628f6acb61094688b39bdfc08fbc",
        "width": null
    }],
    "songPopularity": [{
            "songPopValue": 0,
            "trackCount": 6
        },
        {
            "songPopValue": 1,
            "trackCount": 2
        },
        {
            "songPopValue": 2,
            "trackCount": 4
        },
        {
            "songPopValue": 3,
            "trackCount": 3
        },
        {
            "songPopValue": 4,
            "trackCount": 2
        },
        {
            "songPopValue": 5,
            "trackCount": 2
        },
        {
            "songPopValue": 6,
            "trackCount": 0
        },
        {
            "songPopValue": 7,
            "trackCount": 2
        },
        {
            "songPopValue": 8,
            "trackCount": 1
        },
        {
            "songPopValue": 9,
            "trackCount": 3
        },
        {
            "songPopValue": 10,
            "trackCount": 1
        },
        {
            "songPopValue": 11,
            "trackCount": 2
        },
        {
            "songPopValue": 12,
            "trackCount": 7
        },
        {
            "songPopValue": 13,
            "trackCount": 2
        },
        {
            "songPopValue": 14,
            "trackCount": 1
        },
        {
            "songPopValue": 15,
            "trackCount": 2
        },
        {
            "songPopValue": 16,
            "trackCount": 4
        },
        {
            "songPopValue": 17,
            "trackCount": 2
        },
        {
            "songPopValue": 18,
            "trackCount": 4
        },
        {
            "songPopValue": 19,
            "trackCount": 7
        },
        {
            "songPopValue": 20,
            "trackCount": 11
        },
        {
            "songPopValue": 21,
            "trackCount": 5
        },
        {
            "songPopValue": 22,
            "trackCount": 9
        },
        {
            "songPopValue": 23,
            "trackCount": 3
        },
        {
            "songPopValue": 24,
            "trackCount": 1
        },
        {
            "songPopValue": 25,
            "trackCount": 2
        },
        {
            "songPopValue": 26,
            "trackCount": 4
        },
        {
            "songPopValue": 27,
            "trackCount": 0
        },
        {
            "songPopValue": 28,
            "trackCount": 2
        },
        {
            "songPopValue": 29,
            "trackCount": 2
        },
        {
            "songPopValue": 30,
            "trackCount": 5
        },
        {
            "songPopValue": 31,
            "trackCount": 5
        },
        {
            "songPopValue": 32,
            "trackCount": 0
        },
        {
            "songPopValue": 33,
            "trackCount": 5
        },
        {
            "songPopValue": 34,
            "trackCount": 3
        },
        {
            "songPopValue": 35,
            "trackCount": 5
        },
        {
            "songPopValue": 36,
            "trackCount": 0
        },
        {
            "songPopValue": 37,
            "trackCount": 3
        },
        {
            "songPopValue": 38,
            "trackCount": 9
        },
        {
            "songPopValue": 39,
            "trackCount": 3
        },
        {
            "songPopValue": 40,
            "trackCount": 8
        },
        {
            "songPopValue": 41,
            "trackCount": 2
        },
        {
            "songPopValue": 42,
            "trackCount": 2
        },
        {
            "songPopValue": 43,
            "trackCount": 9
        },
        {
            "songPopValue": 44,
            "trackCount": 5
        },
        {
            "songPopValue": 45,
            "trackCount": 8
        },
        {
            "songPopValue": 46,
            "trackCount": 4
        },
        {
            "songPopValue": 47,
            "trackCount": 12
        },
        {
            "songPopValue": 48,
            "trackCount": 8
        },
        {
            "songPopValue": 49,
            "trackCount": 17
        },
        {
            "songPopValue": 50,
            "trackCount": 16
        },
        {
            "songPopValue": 51,
            "trackCount": 18
        },
        {
            "songPopValue": 52,
            "trackCount": 17
        },
        {
            "songPopValue": 53,
            "trackCount": 17
        },
        {
            "songPopValue": 54,
            "trackCount": 14
        },
        {
            "songPopValue": 55,
            "trackCount": 15
        },
        {
            "songPopValue": 56,
            "trackCount": 21
        },
        {
            "songPopValue": 57,
            "trackCount": 34
        },
        {
            "songPopValue": 58,
            "trackCount": 24
        },
        {
            "songPopValue": 59,
            "trackCount": 18
        },
        {
            "songPopValue": 60,
            "trackCount": 32
        },
        {
            "songPopValue": 61,
            "trackCount": 27
        },
        {
            "songPopValue": 62,
            "trackCount": 27
        },
        {
            "songPopValue": 63,
            "trackCount": 22
        },
        {
            "songPopValue": 64,
            "trackCount": 22
        },
        {
            "songPopValue": 65,
            "trackCount": 17
        },
        {
            "songPopValue": 66,
            "trackCount": 36
        },
        {
            "songPopValue": 67,
            "trackCount": 32
        },
        {
            "songPopValue": 68,
            "trackCount": 15
        },
        {
            "songPopValue": 69,
            "trackCount": 21
        },
        {
            "songPopValue": 70,
            "trackCount": 21
        },
        {
            "songPopValue": 71,
            "trackCount": 22
        },
        {
            "songPopValue": 72,
            "trackCount": 24
        },
        {
            "songPopValue": 73,
            "trackCount": 23
        },
        {
            "songPopValue": 74,
            "trackCount": 23
        },
        {
            "songPopValue": 75,
            "trackCount": 22
        },
        {
            "songPopValue": 76,
            "trackCount": 19
        },
        {
            "songPopValue": 77,
            "trackCount": 17
        },
        {
            "songPopValue": 78,
            "trackCount": 27
        },
        {
            "songPopValue": 79,
            "trackCount": 16
        },
        {
            "songPopValue": 80,
            "trackCount": 17
        },
        {
            "songPopValue": 81,
            "trackCount": 15
        },
        {
            "songPopValue": 82,
            "trackCount": 10
        },
        {
            "songPopValue": 83,
            "trackCount": 11
        },
        {
            "songPopValue": 84,
            "trackCount": 13
        },
        {
            "songPopValue": 85,
            "trackCount": 7
        },
        {
            "songPopValue": 86,
            "trackCount": 3
        },
        {
            "songPopValue": 87,
            "trackCount": 6
        },
        {
            "songPopValue": 88,
            "trackCount": 2
        },
        {
            "songPopValue": 89,
            "trackCount": 0
        },
        {
            "songPopValue": 90,
            "trackCount": 2
        },
        {
            "songPopValue": 91,
            "trackCount": 0
        },
        {
            "songPopValue": 92,
            "trackCount": 0
        },
        {
            "songPopValue": 93,
            "trackCount": 1
        },
        {
            "songPopValue": 94,
            "trackCount": 0
        },
        {
            "songPopValue": 95,
            "trackCount": 0
        },
        {
            "songPopValue": 96,
            "trackCount": 0
        },
        {
            "songPopValue": 97,
            "trackCount": 0
        },
        {
            "songPopValue": 98,
            "trackCount": 0
        },
        {
            "songPopValue": 99,
            "trackCount": 0
        },
        {
            "songPopValue": 100,
            "trackCount": 0
        }
    ],
    "songTimeRange": [{
            "year": 2012,
            "value": 23
        },
        {
            "year": 2011,
            "value": 13
        },
        {
            "year": 2010,
            "value": 17
        },
        {
            "year": 2009,
            "value": 12
        },
        {
            "year": 1998,
            "value": 1
        },
        {
            "year": 2008,
            "value": 14
        },
        {
            "year": 1997,
            "value": 6
        },
        {
            "year": 1974,
            "value": 1
        },
        {
            "year": 2007,
            "value": 13
        },
        {
            "year": 1996,
            "value": 55
        },
        {
            "year": 1995,
            "value": 2
        },
        {
            "year": 2006,
            "value": 23
        },
        {
            "year": 1972,
            "value": 1
        },
        {
            "year": 2005,
            "value": 11
        },
        {
            "year": 1994,
            "value": 3
        },
        {
            "year": 1993,
            "value": 5
        },
        {
            "year": 2004,
            "value": 5
        },
        {
            "year": 2003,
            "value": 10
        },
        {
            "year": 1992,
            "value": 1
        },
        {
            "year": 1970,
            "value": 1
        },
        {
            "year": 2002,
            "value": 6
        },
        {
            "year": 1999,
            "value": 4
        },
        {
            "year": 1977,
            "value": 1
        },
        {
            "year": 2001,
            "value": 3
        },
        {
            "year": 2000,
            "value": 4
        },
        {
            "year": 2019,
            "value": 112
        },
        {
            "year": 2018,
            "value": 107
        },
        {
            "year": 1963,
            "value": 1
        },
        {
            "year": 2017,
            "value": 243
        },
        {
            "year": 1962,
            "value": 1
        },
        {
            "year": 2016,
            "value": 53
        },
        {
            "year": 1983,
            "value": 1
        },
        {
            "year": 2015,
            "value": 130
        },
        {
            "year": 2014,
            "value": 44
        },
        {
            "year": 2013,
            "value": 26
        },
        {
            "year": 1980,
            "value": 1
        },
        {
            "year": 1969,
            "value": 1
        }
    ],
    "topGenres": [{
            "weight": 997,
            "name": "pop rap"
        },
        {
            "weight": 966,
            "name": "rap"
        },
        {
            "weight": 767,
            "name": "hip hop"
        },
        {
            "weight": 617,
            "name": "trap"
        },
        {
            "weight": 462,
            "name": "southern hip hop"
        },
        {
            "weight": 411,
            "name": "pop"
        },
        {
            "weight": 248,
            "name": "gangster rap"
        },
        {
            "weight": 221,
            "name": "dance pop"
        },
        {
            "weight": 204,
            "name": "edm"
        },
        {
            "weight": 196,
            "name": "cali rap"
        },
        {
            "weight": 164,
            "name": "west coast rap"
        },
        {
            "weight": 164,
            "name": "atl hip hop"
        },
        {
            "weight": 153,
            "name": "conscious hip hop"
        },
        {
            "weight": 140,
            "name": "tropical house"
        },
        {
            "weight": 137,
            "name": "r&b"
        },
        {
            "weight": 136,
            "name": "melodic rap"
        },
        {
            "weight": 117,
            "name": "urban contemporary"
        },
        {
            "weight": 112,
            "name": "west coast trap"
        },
        {
            "weight": 104,
            "name": "underground hip hop"
        },
        {
            "weight": 103,
            "name": "big room"
        }
    ],
    "topArtists": null,
    "topAlbums": [{
            "weight": 3.2142857142857144,
            "name": "DAMN.",
            "albumCoverImgURL": "https://i.scdn.co/image/7feaed3c5c6c451326aafad31ea922fb3171f0df"
        },
        {
            "weight": 3.0,
            "name": "All Eyez On Me",
            "albumCoverImgURL": "https://i.scdn.co/image/ab67616d00001e02a786ad0992cfe0b2719729bf"
        },
        {
            "weight": 3.0,
            "name": "American Teen",
            "albumCoverImgURL": "https://i.scdn.co/image/ab67616d00001e02988ede5e1276e758b5f9e577"
        },
        {
            "weight": 3.0,
            "name": "Hourglass: The Remixes",
            "albumCoverImgURL": "https://i.scdn.co/image/ab67616d00001e02280742fe644f7cf454c4ec67"
        },
        {
            "weight": 3.0,
            "name": "If You're Reading This It's Too Late",
            "albumCoverImgURL": "https://i.scdn.co/image/3d84c7e09ffc77e05a6be0f8fd9e45c79f3b2d86"
        },
        {
            "weight": 3.0,
            "name": "ALL-AMERIKKKAN BADA$$",
            "albumCoverImgURL": "https://i.scdn.co/image/ab67616d00001e026a3c1e51a7d2a2a7fbe172a1"
        },
        {
            "weight": 3.0,
            "name": "To Pimp A Butterfly",
            "albumCoverImgURL": "https://i.scdn.co/image/8c157f4c8da3a56957c8c211e3408c7400de3dd7"
        },
        {
            "weight": 2.0769230769230766,
            "name": "Awake",
            "albumCoverImgURL": "https://i.scdn.co/image/ab67616d00001e023636ac7a8af679d425fdefee"
        },
        {
            "weight": 2.0666666666666664,
            "name": "No.6 Collaborations Project",
            "albumCoverImgURL": "https://i.scdn.co/image/ab67616d00001e02a53a148d92ce7afa20229e49"
        },
        {
            "weight": 2.0,
            "name": "Currency",
            "albumCoverImgURL": "https://i.scdn.co/image/ab67616d00001e0246767e03e155e95b24c6a88b"
        },
        {
            "weight": 2.0,
            "name": "Order In Decline",
            "albumCoverImgURL": "https://i.scdn.co/image/ab67616d00001e022ac2cd7dfeb8d4391fdfd763"
        },
        {
            "weight": 1.3846153846153846,
            "name": "The Sufferer & The Witness",
            "albumCoverImgURL": "https://i.scdn.co/image/5d3325b874fbf41ecae4f7f0b3227bfba53733c7"
        },
        {
            "weight": 1.0,
            "name": "Scary Hours",
            "albumCoverImgURL": "https://i.scdn.co/image/ab67616d00001e025e8f046078b784e6f8502008"
        },
        {
            "weight": 0.6666666666666666,
            "name": "MEEKEND MU$IC",
            "albumCoverImgURL": "https://i.scdn.co/image/ab67616d00001e02a71f2ec48b9518655ea550a0"
        },
        {
            "weight": 0.5,
            "name": "Silhouettes",
            "albumCoverImgURL": "https://i.scdn.co/image/ab67616d00001e02d18bcb4b5e0dedf88a990818"
        },
        {
            "weight": 0.5,
            "name": "Save The World",
            "albumCoverImgURL": "https://i.scdn.co/image/a4a2cdc44d4cc68357d802f10565c884cd56ab5f"
        },
        {
            "weight": 0.5,
            "name": "Spotify Singles",
            "albumCoverImgURL": "https://i.scdn.co/image/ab67616d00001e023171d980d3c05ce22739c4be"
        },
        {
            "weight": 0.5,
            "name": "Old Thing Back (feat. Ja Rule and Ralph Tresvant)",
            "albumCoverImgURL": "https://i.scdn.co/image/ab67616d00001e02ded712f661104861ee36c381"
        },
        {
            "weight": 0.5,
            "name": "Concrete Angel",
            "albumCoverImgURL": "https://i.scdn.co/image/ab67616d00001e0250a657ad70e3eaff49027611"
        },
        {
            "weight": 0.5,
            "name": "The Play Donâ€™t Care Who Makes It",
            "albumCoverImgURL": "https://i.scdn.co/image/16c75317c67b7ef8fc07bbff4b07a0858ab8fa79"
        }
    ],
    "recentlyPlayedPlaylistURI": null
}
*/


function renderUserProfile(userProfileObj) {
    if (!userProfileObj) {
        userProfileObj = testUserProfileObj;
    }
    // Render user image
    const userImageRow = document.createElement('div');
    userImageRow.className = "row";
    const userImageCol = document.createElement('div');
    userImageCol.className = "col-lg";
    userImageCol.align = "center";
    const userImage = document.createElement('img');
    if (userProfileObj.images[0])
        userImage.src = userProfileObj.images[0]['url'];
    else
        userImage.src = 'https://statici.behindthevoiceactors.com/behindthevoiceactors/_img/chars/linus-van-pelt-charlie-browns-all-stars-46.9.jpg'
    userImage.className = "rounded-circle mt-4";
    userImage.style = "width:12em;height:12em";
    userImageCol.appendChild(userImage);
    userImageRow.appendChild(userImageCol);
    document.getElementById('user-info-container').appendChild(userImageRow);
    // Render user display name
    const userDisplayNameRow = document.createElement('div');
    userDisplayNameRow.className = "row";
    const userDisplayNameCol = document.createElement('div');
    userDisplayNameCol.className = "col-lg";
    userDisplayNameCol.align = "center";
    const userDisplayNameHeader = document.createElement('h2');
    userDisplayNameHeader.className = "text-white";
    userDisplayNameHeader.style = "padding-top:0.5em;"
    userDisplayNameHeader.innerHTML = 'Welcome, ' + userProfileObj.displayName + '!';

    userDisplayNameCol.appendChild(userDisplayNameHeader);

    userDisplayNameRow.appendChild(userDisplayNameCol);
    document.getElementById('user-info-container').appendChild(userDisplayNameRow);
}

function renderFavoriteGenres(userProfileObj) {
    if (!userProfileObj) {
        userProfileObj = testUserProfileObj;
    }
    const genreObj = { 'children': userProfileObj['topGenres'] };
    const diameter = 800;
    const color = d3.scaleOrdinal(d3.schemeCategory20);
    const bubble = d3.pack(genreObj)
        .size([diameter, diameter])
        .padding(1.5);
    const svg = d3.select("#genre-chart-column")
        .append("svg")
        .attr("width", diameter)
        .attr("height", diameter)
        .attr("class", "bubble");
    const nodes = d3.hierarchy(genreObj)
        .sum(function(d) { return d.weight; });
    const node = svg.selectAll(".node")
        .data(bubble(nodes).descendants())
        .enter()
        .filter(function(d) {
            return !d.children
        })
        .append("g")
        .attr("class", "node")
        .attr("transform", function(d) {
            return "translate(" + d.x + "," + d.y + ")";
        });
    node.append("title")
        .text(function(d) {
            return d.name + ": " + d.weight;
        });
    node.append("circle")
        .attr("r", function(d) {
            return d.r;
        })
        .style("fill", function(d, i) {
            return color(i);
        });
    node.append("text")
        .attr("dy", ".2em")
        .style("text-anchor", "middle")
        .text(function(d) {
            return d.data.name;
        })
        .attr("font-family", "sans-serif")
        .attr("font-size", function(d) {
            return d.r / 5;
        })
        .attr("fill", "white");

    d3.select(self.frameElement)
        .style("height", diameter + "em");
}

function renderFavoriteAlbums(userProfileObj) {
    if (!userProfileObj) {
        userProfileObj = testUserProfileObj;
    }
    const albumObj = userProfileObj['topAlbums']
    // Compute number of rows needed
    const rowLength = Math.floor(albumObj.length / 5);
    if (albumObj.length % 5 > 0) rowLength++;
    // Number of albums we've filled into a column. Used to make sure we don't check an index out of bounds in the album array.
    let albumCount = 0;
    // Create rowLength number of rows with 4 columns each
    for (i = 0; i < rowLength; i++) {
        // Create a row div
        const rowDiv = document.createElement('div');
        rowDiv.className = 'row no-gutters';
        // Append 4 column divs into the row div.
        for (j = 0; j < 4; j++) {
            // If albumCount has exceeded album array length, then leave empty. Otherwise fill with album info.
            const colDiv = document.createElement('div');
            colDiv.className = 'col-sm';
            if (albumCount < albumObj.length) {
                // Create viewOverlayDiv for hover effect capability
                const viewOverlayDiv = document.createElement('div');
                viewOverlayDiv.className = 'view overlay mx-2';
                // Append the album img to viewOverlayDiv
                const albumArtImg = document.createElement('img');
                albumArtImg.className = 'img-fluid';
                albumArtImg.src = albumObj[albumCount].albumCoverImgURL;
                viewOverlayDiv.appendChild(albumArtImg);
                // Append maskDiv to viewOverlayDiv which enables the hover effect
                const maskDiv = document.createElement('div');
                maskDiv.className = 'mask flex-center rgba-white-strong';
                // Append text to maskDiv to show up when hovering
                const albumTitleP = document.createElement('p');
                albumTitleP.className = 'text-break black-text text-center font-weight-bold';
                albumTitleP.innerHTML = albumObj[albumCount].name; //+ "<br>" + albumObj.albums[albumCount].artist;
                maskDiv.appendChild(albumTitleP);
                viewOverlayDiv.appendChild(maskDiv);
                colDiv.appendChild(viewOverlayDiv);
                albumCount++;
            }
            rowDiv.appendChild(colDiv);
        }
        // Append the row div onto collageContainer div
        document.getElementById('collage-container').appendChild(rowDiv);
    }
}
const refresh_token = localStorage.getItem('refreshToken');
const userProfileUrl = 'https://my-tunes-be.herokuapp.com/userProfileModel?refreshToken=' + refresh_token;

const subContainer = document.getElementById('sub-container');
subContainer.style.display = 'none';

fetch(userProfileUrl)
    .then(res => res.json())
    .then(jsondata => {
        console.log(jsondata);
        subContainer.style.display = 'block';
        document.getElementById('loader').style.display = 'none';

        renderUserProfile(jsondata); 
        renderFavoriteAlbums(jsondata); 
        renderFavoriteGenres(jsondata);
});


