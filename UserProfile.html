<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="styles/UserProfile.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.8.10/css/mdb.min.css" rel="stylesheet">
    <!-- JQuery -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <!-- Bootstrap tooltips -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.4/umd/popper.min.js"></script>
    <!-- Bootstrap core JavaScript -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <!-- MDB core JavaScript -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.8.10/js/mdb.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script type="module" src="global.js"></script>
    <title>Profile</title>
  </head>
  <body class="bg-dark">
    <div id="user-info-container" class="container"></div>
    <div id="genre-chart-container" class="container">
      <div class="row">
        <div class="col-lg">
          <div id="genre-chart-column" class="col-lg" align="center">
          </div>
        </div>
      </div>
      <div id="collage-container" class="container">
        <div class="row no-gutters">
          <div class="col-sm">
            <h1 class="display-4 text-white">Favorite Albums</h1>
          </div>
        </div>
      </div>
      <script>
       var refresh_token = 'AQAIEyJiRpsbWZ42Hl3JJMkRJns6JFFi1mItJu_Jiz6VrbjB22a0N_ZjtPYCHRVWhHy5SE_ANLbLzomRkbSJBatbRinsgGa5L3rM9qrlWFHjOAwPnw_28mmTszboF9OzIks93A'

       // Make GET request for user info and render user image and display name
       const httpUserInfo = new XMLHttpRequest();
       const userInfoUrl = 'https://my-tunes-be.herokuapp.com/userProfile?refreshToken=' + refresh_token;
       httpUserInfo.open("GET", userInfoUrl);
       httpUserInfo.onreadystatechange = function(){
         if(httpUserInfo.readyState == 4 && httpUserInfo.status == 200){
           var userObj = JSON.parse(httpUserInfo.response);

           // Render user image
           var userImageRow = document.createElement('div');
           userImageRow.className = "row";

           var userImageCol = document.createElement('div');
           userImageCol.className = "col-lg";
           userImageCol.align = "center";

           var userImage = document.createElement('img');
           if (userObj.images[0])
             userImage.src = userObj.images[0];
           else
             userImage.src = 'https://statici.behindthevoiceactors.com/behindthevoiceactors/_img/chars/linus-van-pelt-charlie-browns-all-stars-46.9.jpg'

           userImage.className = "rounded-circle";
           userImage.style = "width:12em;height:12em";

           userImageCol.appendChild(userImage);
           userImageRow.appendChild(userImageCol);
           document.getElementById('user-info-container').appendChild(userImageRow);

           // Render user display name
           var userDisplayNameRow = document.createElement('div');
           userDisplayNameRow.className = "row";

           var userDisplayNameCol = document.createElement('div');
           userDisplayNameCol.className = "col-lg";
           userDisplayNameCol.align = "center";

           var userDisplayNameHeader = document.createElement('h2');
           userDisplayNameHeader.className = "text-white";
           userDisplayNameHeader.style = "padding-top:0.5em;"
           userDisplayNameHeader.innerHTML = userObj.displayName;

           userDisplayNameCol.appendChild(userDisplayNameHeader);
           userDisplayNameRow.appendChild(userDisplayNameCol);
           document.getElementById('user-info-container').appendChild(userDisplayNameRow);
         }
       };
       httpUserInfo.send();

       // Make GET request for userProfileModel which contains top album information, top genres, song popularity, and song time range preferences.
       const httpUserProfile = new XMLHttpRequest();
       const userProfileUrl = 'https://my-tunes-be.herokuapp.com/userProfileModel?refreshToken=' + refresh_token;
       httpUserProfile.open("GET", userProfileUrl);
       httpUserProfile.onreadystatechange = function(){
         if(httpUserProfile.readyState == 4 && httpUserProfile.status == 200){
           var userProfileObj = JSON.parse(httpUserProfile.response);
           var albumObj = userProfileObj['topAlbums']
           var genreObj = { 'children': userProfileObj['topGenres'] };

           // Render favorite albums
           // Compute number of rows needed
           var rowLength = Math.floor(albumObj.length / 5);
           if (albumObj.length % 5 > 0) rowLength++;

           // Number of albums we've filled into a column. Used to make sure we don't check an index out of bounds in the album array.
           var albumCount = 0;

           // Create rowLength number of rows with 4 columns each
           for (i = 0; i < rowLength; i++) {
             // Create a row div
             var rowDiv = document.createElement('div');
             rowDiv.className = 'row no-gutters';

             // Append 4 column divs into the row div.
             for (j = 0; j < 4; j++) {
               // If albumCount has exceeded album array length, then leave empty. Otherwise fill with album info.
               var colDiv = document.createElement('div');
               colDiv.className = 'col-sm';

               if (albumCount < albumObj.length) {
                 // Create viewOverlayDiv for hover effect capability
                 var viewOverlayDiv = document.createElement('div');
                 viewOverlayDiv.className = 'view overlay';

                 // Append the album img to viewOverlayDiv
                 var albumArtImg = document.createElement('img');
                 albumArtImg.className = 'img-fluid';
                 albumArtImg.src = albumObj[albumCount].albumCoverImgURL;
                 viewOverlayDiv.appendChild(albumArtImg);

                 // Append maskDiv to viewOverlayDiv which enables the hover effect
                 var maskDiv = document.createElement('div');
                 maskDiv.className = 'mask flex-center rgba-white-strong';

                 // Append text to maskDiv to show up when hovering
                 var albumTitleP = document.createElement('p');
                 albumTitleP.className = 'text-break black-text text-center font-weight-bold';
                 albumTitleP.innerHTML = albumObj[albumCount].name; //+ "<br>" + albumObj.albums[albumCount].artist;
                 maskDiv.appendChild(albumTitleP);
                 viewOverlayDiv.appendChild(maskDiv);
                 colDiv.appendChild(viewOverlayDiv);
                 albumCount++;
               }
               rowDiv.appendChild(colDiv);
             }
             // Append the row div onto collageContainer div
             document.getElementById('collage-container').appendChild(rowDiv);
           }

             // Render bubble chart, uses v4 of d3
           var diameter = 800;
             var color = d3.scaleOrdinal(d3.schemeCategory20);

           var bubble = d3.pack(genreObj)
                          .size([diameter, diameter])
                          .padding(1.5);

           var svg = d3.select("#genre-chart-column")
                       .append("svg")
                       .attr("width", diameter)
                       .attr("height", diameter)
                       .attr("class", "bubble");

           var nodes = d3.hierarchy(genreObj)
                         .sum(function(d) { return d.weight; });

           var node = svg.selectAll(".node")
                         .data(bubble(nodes).descendants())
                         .enter()
                         .filter(function(d){
                           return  !d.children
                         })
                         .append("g")
                         .attr("class", "node")
                         .attr("transform", function(d) {
                           return "translate(" + d.x + "," + d.y + ")";
                         });

           node.append("title")
               .text(function(d) {
                 return d.name + ": " + d.weight;
               });

           node.append("circle")
               .attr("r", function(d) {
                 return d.r;
               })
               .style("fill", function(d,i) {
                 return color(i);
               });

           node.append("text")
               .attr("dy", ".2em")
               .style("text-anchor", "middle")
               .text(function(d) {
                 return d.data.name;
               })
               .attr("font-family", "sans-serif")
               .attr("font-size", function(d){
                 return d.r/5;
               })
               .attr("fill", "white");
           
           d3.select(self.frameElement)
             .style("height", diameter + "em");
         }
       };
       httpUserProfile.send();

       var genres = ' {"children": [{"weight":281,"name":"pop"},{"weight":264,"name":"rap"},{"weight":255,"name":"pop rap"},{"weight":210,"name":"hip hop"},{"weight":176,"name":"trap music"},{"weight":155,"name":"southern hip hop"},{"weight":153,"name":"dance pop"},{"weight":89,"name":"gangster rap"},{"weight":88,"name":"edm"},{"weight":74,"name":"r&b"},{"weight":72,"name":"urban contemporary"},{"weight":67,"name":"tropical house"},{"weight":57,"name":"post-teen pop"},{"weight":56,"name":"electro pop"},{"weight":55,"name":"electro house"},{"weight":54,"name":"cali rap"},{"weight":49,"name":"atl hip hop"},{"weight":45,"name":"pop edm"},{"weight":43,"name":"underground hip hop"},{"weight":42,"name":"west coast trap"}]}'

       // Render pie chart, uses v3 of d3
       /*
          var width = 800,
          height = 250,
          radius = Math.min(width, height) / 2;

          var color = d3.scale.ordinal()
          .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);

          var arc = d3.svg.arc()
          .outerRadius(radius - 10)
          .innerRadius(radius - 70);

          var pie = d3.layout.pie()
          .sort(null)
          .value(function (d) {
          return d.weight;
          });

          var svg = d3.select("#genre-chart-column").append("svg")
          .attr("width", width)
          .attr("height", height)
          .append("g")
          .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

          var g = svg.selectAll(".arc")
          .data(pie(genreObj))
          .enter().append("g")
          .attr("class", "arc");

          g.append("path")
          .attr("d", arc)
          .style("fill", function (d) {
          return color(d.data.name);
          });

          g.append("text")
          .attr("transform", function (d) {
          return "translate(" + arc.centroid(d) + ")";
          })
          .attr("dy", ".35em")
          .style("text-anchor", "middle")
          .text(function (d) {
          return d.data.name;
          });
        */

      </script>
  </body>
</html>
